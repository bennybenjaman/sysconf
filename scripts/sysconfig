#!/usr/bin/env bash

set -x
set -e

if [ "$(id -u)" != "0" ]; then
    echo "must be root"
    exit 1
fi

set -x


# Append str <pattern> at EOF of <file>. If <pattern> is already at
# EOF do nothing.
append_line_to_file() {
    file=$1 pattern=$2 python << END
if 1:
    import os, sys
    try:
        file = os.environ['file']
        pattern = os.environ['pattern']
    except (KeyError, AssertionError):
        sys.exit('usage: append_line_to_file <fname> <pattern>')
    with open(file, 'r') as f:
        data = f.read()
        data.rstrip()
        last_line = data.splitlines()[-1]
    if last_line != pattern:
        with open(file, 'a') as f:
            f.write(pattern.strip() + '\n')
END
}


# This is here as an utility fun for other bash scripts.
# Replace str <src> with str <dst> in <file>.
# This is here as an utility fun for other bash scripts.

replace_in_file() {
    file=$1 src=$2 dst=$3 python << END
if 1:
    import os, sys
    try:
        file = os.environ['file']
        src = os.environ['src']
        dst = os.environ['dst']
    except (KeyError, AssertionError):
        sys.exit('usage: _replace_in_file <fname> <src> <dst>')
    with open(file, 'r') as f:
        data = f.read()
    new_data = data.replace(src, dst)
    if data != new_data:
        with open(file, 'w') as f:
            f.write(new_data)
END
}



# no passwd for sudo
set_sudo_no_passwd() {
    if [ -f /etc/sudoers ]; then
        # linux
        append_line_to_file /etc/sudoers "$USER ALL=(ALL) NOPASSWD: ALL"
    elif [ -f /usr/local/etc/sudoers ]; then
        # bsd
        append_line_to_file /usr/local/etc/sudoers "$USER ALL=(ALL) NOPASSWD: ALL"
    else
        echo "can't find the sudoers file; is sudo instaled?" && exit 1
    fi
}



# ===================================================================
# Linux
# ===================================================================

if [[ $PLATFORM    == *"linux"* ]]; then
    # disable error reports
    append_line_to_file /etc/default/apport "enabled=0"

    # remove unwanted apps
    apt-get remove -y totem gedit
fi


# ===================================================================
# All
# ===================================================================

# config sshd
append_line_to_file /etc/ssh/sshd_config "PermitRootLogin yes"

# config sudo
if type -P sudo > /dev/null; then
    set_sudo_no_passwd
fi
